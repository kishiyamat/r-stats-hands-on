---
title: "Day1"
output: html_document
# output: ioslides_presentation
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 『Rで学ぶ統計学入門』勉強会

## 概要

-   『Rで学ぶ統計学入門』を教科書として統計学の基本(t検定まで)と
    初歩的、応用（8章までと補足）を進める。
-   ゴールは統計の全体像を掴んで、とりあえず与えられたデータに対して
    適切な手法を選択、実行できるようになること
-   **統計学の厳密な部分には立ち入らない**
    -   こういうケースで何をすればいいのか、の説明のみ
    -   より細かく知りたい場合は教科書の該当部分を参照

## 全体のアウトライン

Day1

-   **R/RStudio**
-   t検定
-   補足: t検定と線形モデル
-   ANOVA

Day2

-   GLM
-   ランダム構造
-   モデル選択

## R/RStudio

このチュートリアルはRStudioという、
Rを使いやすくする環境を使って進めていきます。

-   環境の確認
-   R/RStudio(Server)
-   チュートリアルの進め方

なおR自体の説明は教科書冒頭にあります(pp.1--2)

-   オープンソース
-   統計に強い
-   可視化も楽

## 環境の確認

1.  <https://binder.cs.rcos.nii.ac.jp/v2/gh/kishiyamat/r-stats-hands-on/main>
    にアクセス（アクセスするたびに環境が作られます）
2.  NIIのウェブページで所属機関を[選択]し、ご自身の所属機関で認証
    (自分用の分析環境が新たに作られます)
3.  Files の右側にある New → RStudio をクリック (RStudio
    が新しいタブで開きます)

この次点では以下の「ペイン」が利用できます。

-   左の「Console」
-   右上の「Environment」
-   右下の「Files」

注意：この環境は練習用です。詳しくは
<https://meatwiki.nii.ac.jp/confluence/pages/viewpage.action?pageId=67614937>
をご参照ください。

## R/RStudio(Server)

Rの実行

-   Files から day1.Rmd を選択して「エディター」を開きましょう
-   Consoleを使ってRを試してみましょう(p.23)。
-   色々な実行法があります。緑矢印が１番ラク

四則演算(`+-*/`)と代入(`<-`)、コメント(`#`)

```{r}
# <- で変数に代入できます。変数の上書きはできるだけ避けましょう。
a <- 10
# 式をConsoleにコピペするもよし、右上の緑▶を押すもよし、
# Macは⌘エンター、WindowsはCtrlエンターもよし
x <- (5+3)*2-a/5
# Environment で値をチェックできる
```

関数は入力をカッコ`()`に与えると出力を返します。
このように、関数は引数（ひきすう）を取り、 返り値を持ちます。

```{r}
# 数値列作成のc
d <- c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10)
# 平均を求める mean
mean(d)
# (不偏)分散を求める
var(d)
# 標準偏差を求めるsd
sd(d)
```

## チュートリアルの進め方

-   配置は 左上に「Editor」、右上に「Environment」、
    左下に「Console」、右下に「Files」
-   Editorのファイルを実行しながら説明していく
-   質問があったら随時うけつけます。

以上の関数は数値列を引数にしましたが、
統計では「データフレーム」をよく扱います。

## 全体のアウトライン

Day1

-   R/RStudio
-   **t検定**
-   補足: t検定と線形モデル
-   ANOVA

Day2

-   GLM
-   ランダム構造
-   モデル選択

## t検定

-   統計的仮説検定の必要性(1章)
-   統計的仮説検定(5章)
    -   data.frame
-   t検定ハンズオン
-   線形モデルとの関連

## 統計的仮説検定

### 統計学を学ぶ大切さ(1章)

データの解釈を批判的に見てみる練習をしましょう

-   (1)の第一パラグラフを読み、以下を行ってください。
    -   **仮説**と**実験**、**結果**と**解釈**に整理してください。
    -   解釈が妥当か妥当でないか、根拠を考えて整理してください。

想定解答

1.  妥当 (上がったのは事実なので仮説は支持できる)
2.  妥当でない
    (時間の効果かもしれないので、なにもしない比較対象のグループが必要)
3.  妥当でない (一人のデータからそんなに強く主張できない)

-\> 誤った解釈を回避したい場合、いくつか方法がある

-   比較する条件や水準をデザインする
-   複数人からデータをとる
-   「意味のある差」のしきい値を設ける (41--43は？)

他にも方法は色々ありますが、典型的な主張の展開である
「帰無仮説検定」をみてみましょう。

### 帰無仮説検定(5章)

(2,3,4章は適宜参照します。)

-   ２つのグループ（処置の前後、母語Aと母語Bなどなど）の間で
    母集団の間で差があるとき、
    グループ間で「有意な差」があると言います。 -「data.frame」 を head
    でみてみましょう

教科書p.48の(a)は以下です。

```{r}
# 教科書p.48の(a): 小学校aの男女の身長
data_a <- data.frame(
    m = c(143.1, 140.9, 147.2, 139.8, 141.3, 150.7, 149.4, 145.6, 146.5, 148.5, 141.2, 136.5, 145.8, 148.1, 144.3), 
    f = c(138.7, 142.8, 150.3, 148.4, 141.7, 149.5, 156.5, 144.6, 144.4, 145.7, 148.3, 140.8, 146.2, 149.9, 144.1)
)
head(data_a)
```

```{r}
# 最小値、平均値、最大値がわかります
summary(data_a)
# 平均の差は144.6-146.1
# data.frameの列は$で参照できます
summary(data_a)
```

```{r}
# 平均の差
abs(144.6-146.1)
# 列は$で参照できる
sd(data_a$m)
sd(data_a$f)
```

mの標準偏差(`sd`)は4.03, fの`sd`は4.50で、 平均の差は1.5になる。
対して、教科書p.48の(b)は以下です。 平均の差は同じく1.5ですが、
sdは男女それぞれ1.4と1.8です。

```{r}
# 教科書p.48の(b) 小学校bの男女の身長
data_b <- data.frame(
    m = c(142.3, 142.5, 145.7, 143.5, 144.2, 145.1, 145.9, 145.2, 146.8, 145.7, 145.4, 144.6, 144.2, 145.9, 142.1),
    f = c(143.5, 144.6, 143.4, 146.6, 145.3, 147.7, 147.2, 147.8, 145.3, 145.7, 147.5, 147.2, 148.8, 147.9, 143.3)
)
head(data_b)
summary(data_b)
sd(data_b$m)
sd(data_b$f)
```

上記の男女のデータ(a)から
「このサンプルデータ(a)を引っ張ってきた母集団のグループ（ここでは男女）は
母平均（母集団の平均値）が異なる」と主張できるか。
男女のデータ(b)からならどうか。

「身長なんて興味ない」という場合は、
自分が分析したいデータに置き換えてみましょう。
(連続値にしろ離散値にしろ、全てのケースは後でカバーされます)

-   母語によって反応時間(あるいは正答率)は変わるか
-   教育法によって成績は変わるか
-   作家の年代や属性によってある構文の出現率は変わるか

などなど。

-\> いずれにせよ、以下の手順を踏みます(p.49)

## 帰無仮説と対立仮説

1.  「母集団の平均は同じだ」という「帰無仮説」を立てる

-   母語によって反応時間(あるいは正答率)は変わらない
-   教育法によって成績は変わらない
-   作家の年代や属性によってある構文の出現率は変わらない

1.  帰無仮説を棄却する水準αを決める（分野で決まっていて、大抵は0.05）
2.  対立仮説(グループの違いが差を生んだ)の採用/棄却を決める

-   「母集団の平均は同じ→グループ間の差が小さいデータが得られる」
-   「グループ間の差」を反映する$t$値を計算
    -   $t$値はグループ間の差をデータのばらつきで割ったもの
    -   → グループ間の差が小さかったり、ばらつきが大きいと0に近づく
-   $t$値は下の確率分布($t$分布)に従うので「グループ間の差がない」確率を求められる
-   「グループ間の差がない」確率がα未満なら、以下のステップを踏む
    1.  「グループ間の差が小さいデータが得られなかった」(有意な差があった)
    2.  「母集団の平均は同じではない」
    3.  帰無仮説を棄却、対立仮説を採用

```{r}
# 自由度8のt分布の見た目
t = seq(-3, 3, 0.1)
plot(t, dt(t, df=8))
```

別のケース

-   これはノートパソコンである(仮説)→キーボードがある(データ)
    -   キーボードがない→「これはノートパソコンではない」(仮説の棄却)
    -   ただし、**「キーボードがある→これはノートパソコンだ」とはいえない。**
        (例: デスクトップPC)
        \*「母集団の平均は同じ(帰無仮説)」→「グループ間の差が小さいデータが得られる」
    -   「グループ間の差が小さいデータが得られない」→「同じではない」
    -   ただし、**「グループ間の差が小さいデータが得られる→同じ」**とはいえない。
        （例:
        適当な被験者がランダムに押しても、帰無仮説を支持するデータは得られる）

帰無仮説が真（本当は効果ない）なのに帰無仮説を棄却して対立仮説を採用する
のが致命的にまずい(これをType1-Errorと呼ぶ)。
αが小さくなればなるほど、帰無仮説の棄却は難しくなるので、 Type1-Error
はおきづらくなる(5章参照)。

## t検定ハンズオン

手順の復習

1.  帰無仮説を用意する

-   母語によって反応時間(あるいは正答率)は変わらない
-   教育法によって成績は変わらない
-   作家の年代や属性によってある構文の出現率は変わらない

2.  αを0.05に決める
3.  帰無仮説通りグループ間の差がない確率を求め、
    0.05以下なら帰無仮説を棄却して対立仮説を採用する

実際にデータ(a)と(b)試してみましょう。

```{r}
head(data_a)
t.test(data_a$m, data_a$f, var=T)
```

data_aでは差が偶然である確率が0.3345なので、
手順3で帰無仮説を棄却できない(有意差なし)。
ここでいうtの値はp.51の式(5.1)にあるように以下となる。
(1をm、2をfとしている)
帰無仮説は「母平均に差がない」なので、$\mu_m-\mu_f$は0になる。
そして手元のデータの差が小さければ$t$は0に近づく(分子)。
また、データのばらつきが大きければ$t$はさらに0に近づく(分母)。

$$
t=\frac{(\bar{X_m}-\bar{X_f})-(\mu_m-\mu_f)}{s_{\bar{X_m}-\bar{X_f}}}
$$

よりばらつきの小さかった（分母が小さく、つまり0から離れる）
`data_b`も見てみると、たしかにtは大きくなっている。
同時に、p値は小さくなっている。

```{r}
t.test(data_b$m, data_b$f, var=T)
```

$p$がαより小さいので、データ(b)からは帰無仮説を棄却できる。
したがって、対立仮説の「グループ間で母平均に差はある」を採用する。
df(自由度)はt値を求める際の分母(ばらつき)を求めるときにが必要 95 percent
confidence interval(CI)は対立仮説の0を含まないので、
棄却される(求め方はp.42の式4.3-\>4.4を5.1に適用)。

なお、差が+、あるいは-になると理論的にわかっている場合は
「片側検定」が使える。その際は$t$値が少し0に近づく(p.57)。

先程のデータは異なる個体の差を見たが、
同じ個体の変化を見る場合は「対応有りの$t$検定」が使える(p.61の5.6)。

また、$t$検定で仮定している正規性を確かめる方法はp.63、
グループ間の分散が異なる場合の対処はp.65以降にのっている。

## 全体のアウトライン

Day1

-   R/RStudio
-   t検定
-   **補足: t検定と線形モデル**
-   ANOVA

Day2

-   GLM
-   ランダム構造
-   モデル選択

## 線形モデルとの関連 (補足)

Day2でt検定やANOVAを拡張した線形モデルを扱うので、
t検定も線形モデルの枠組みで考えられることを補足

まず、身長をy、性別をxとしたとき、 y = ax + b
のような式で関連づけられます。
説明のため、データの形式を以下のように変更します。

```{r}
library(ggplot2)
data_c <- data.frame(sex=c(rep(1, 15), rep(0, 15)),
            height=c(data_b$m, data_b$f))
data_c

# 図示
ggplot(data_c, aes(x=as.factor(sex), y=height)) +
  geom_boxplot()
```

上の図を見ると、x軸のfactorが0-\>1になると、平均値の分だけマイナスになることがわかります。
そうなると、もともとの式は y = -1.51\*性別 + 146.1 のように表せます。
これを線形モデルでは「フォーミュラ」を使って表現します。
従属変数`~`独立変数のように表現します。

```{r}
# モデル
summary(lm(height~sex, data=data_c))
s_delta <- 0.5998
summary(lm(height/s_delta~sex, data_c))
```

そうすると、Estimateが-1.51, sdが0.59,
tが-2.52(と、それに伴うp値)が一致しました。
ここでの$t$はもちろん、Estimate(傾きであり差でもある)/sd(ばらつき)です。

```{r}
# 結果は線形モデルと一致する
t.test(data_b$m, data_b$f, var=T)
```

t検定にはいくつも制限があります。
上の線形モデルの枠組みを広げていくと、以下の制限もなくなります。

-   独立変数はカテゴリカル(K=2)
-   従属変数は連続値(正規分布)
-   構造的なノイズを扱いづらい

## 全体のアウトライン

Day1

-   R/RStudio
-   t検定
-   補足: t検定と線形モデル
-   **ANOVA**

Day2

-   GLM
-   ランダム構造
-   モデル選択

## ANOVA

-   ANOVAの概要
-   1要因3水準
-   2要因2水準
-   補足

## ANOVAの概要

t検定の制限

-   **独立変数はカテゴリカル(K=2)**
-   従属変数は連続値(正規分布)
-   構造的なノイズを扱いづらい

ありうる分析したいケース(Kが3以上ある)

1.  一要因で水準が3以上あるケース(多重比較はｘ)
2.  要因が2つあって水準が2あるケース(交互作用の話)

## 1要因3水準(概要)

-   2つのグループの差ではなく、
-   t検定を繰り返すのはType1-Errorが起きやすくなる
-   分散分析

## 1要因3水準(ハンズオン)

## 2要因2水準(概要)

-   実験計画

## 2要因2水準(ハンズオン)

## 補足: ANOVAのF1,F2分析

## 全体のアウトライン

-   独立変数はカテゴリカル(K=2) -\> K\>3は対応可能だが、連続値はx
-   従属変数は連続値(正規分布) -\> カテゴリカルな反応はx(正誤や個数など)
-   構造的なノイズを扱いづらい -\> GLMを使うと簡単にモデリングできる

Day1

-   R/RStudio
-   t検定
-   補足: t検定と線形モデル
-   ANOVA

**Day2**

-   GLM
-   ランダム構造
-   モデル選択
