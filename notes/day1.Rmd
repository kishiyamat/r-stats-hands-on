---
title: "Day1"
output: html_document
# output: ioslides_presentation
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(readr)
library(dplyr)
```

# 『Rで学ぶ統計学入門』勉強会

## 概要

-   『Rで学ぶ統計学入門』を教科書として統計学の基本(t検定まで)と
    初歩的、応用（8章までと補足）を進める。

-   ゴールは統計の全体像を掴んで、とりあえず与えられたデータに対して
    適切な手法を選択、実行できるようになること

-   **統計学の厳密な部分には立ち入らない**

    -   こういうケースで何をすればいいのか、の説明のみ
    -   より細かく知りたい場合は教科書の該当部分を参照

## チュートリアルの進め方

-   配置は 左上に「Editor」、右上に「Environment」、
    左下に「Console」、右下に「Files」
-   Editorのファイルを実行しながら説明していく
-   質問があったら随時うけつけます。

## 全体のアウトライン

Day0

-   R/RStudio

Day1

-   **t検定**
-   補足: t検定と線形モデル
-   ANOVA

Day2

-   LME
-   ランダム構造
-   モデル選択

## t検定

-   統計的仮説検定の必要性(1章)

-   統計的仮説検定(5章)

    -   data.frame

-   t検定ハンズオン

-   線形モデルとの関連

## 統計的仮説検定

### 統計学を学ぶ大切さ(1章)

データの解釈を批判的に見てみる練習をしましょう

-   (1)の第一パラグラフを読み、以下を行ってください。

    -   **仮説**と**実験**、**結果**と**解釈**に整理してください。
    -   解釈が妥当か妥当でないか、根拠を考えて整理してください。

想定解答

1.  妥当 (上がったのは事実なので仮説は支持できる)
2.  妥当でない
    (時間の効果かもしれないので、なにもしない比較対象のグループが必要)
3.  妥当でない (一人のデータからそんなに強く主張できない)

→ 誤った解釈を回避したい場合、いくつか方法がある

-   比較する条件や水準をデザインする
-   複数人からデータをとる
-   「意味のある差」のしきい値を設ける (41--44は？)

他にも方法は色々ありますが、典型的な主張の展開である
「帰無仮説検定」をみてみましょう。

### 帰無仮説検定(5章)

(2,3,4章は適宜参照します。)

-   ２つのグループ（処置の前後、母語Aと母語Bなどなど）の間で
    母集団の間で差があるとき、
    グループ間で「有意な差」があると言います。
-   「data.frame」 を head でみてみましょう

教科書p.48の(a)は以下です。

```{r}
# 教科書p.48の(a): 小学校aの男女の身長
data_a <- data.frame(
  m = c(143.1, 140.9, 147.2, 139.8, 141.3, 150.7, 149.4, 145.6, 146.5, 148.5, 141.2, 136.5, 145.8, 148.1, 144.3),
  f = c(138.7, 142.8, 150.3, 148.4, 141.7, 149.5, 156.5, 144.6, 144.4, 145.7, 148.3, 140.8, 146.2, 149.9, 144.1)
)
head(data_a)
```

```{r}
# 最小値、平均値、最大値がわかります
summary(data_a)
# 平均の差は144.6-146.1
# data.frameの列は$で参照できます
summary(data_a)
```

```{r}
# 平均の差
abs(144.6 - 146.1)
# 列は$で参照できる
sd(data_a$m)
sd(data_a$f)
```

mの標準偏差(`sd`)は4.03, fの`sd`は4.50で、 平均の差は1.5になる。
対して、教科書p.48の(b)は以下です。 平均の差は同じく1.5ですが、
sdは男女それぞれ1.4と1.8です。

```{r}
# 教科書p.48の(b) 小学校bの男女の身長
data_b <- data.frame(
  m = c(142.3, 142.5, 145.7, 143.5, 144.2, 145.1, 145.9, 145.2, 146.8, 145.7, 145.4, 144.6, 144.2, 145.9, 142.1),
  f = c(143.5, 144.6, 143.4, 146.6, 145.3, 147.7, 147.2, 147.8, 145.3, 145.7, 147.5, 147.2, 148.8, 147.9, 143.3)
)
head(data_b)
summary(data_b)
sd(data_b$m)
sd(data_b$f)
```

上記の男女のデータ(a)から
「このサンプルデータ(a)を引っ張ってきた母集団のグループ（ここでは男女）は
母平均（母集団の平均値）が異なる」と主張できるか。
男女のデータ(b)からならどうか。

「身長なんて興味ない」という場合は、
自分が分析したいデータに置き換えてみましょう。
(連続値にしろ離散値にしろ、全てのケースは後でカバーされます)

-   母語によって反応時間(あるいは正答率)は変わるか
-   教育法によって成績は変わるか
-   作家の年代や属性によってある構文の出現率は変わるか

などなど。

→ いずれにせよ、以下の手順を踏みます(p.49)

## 帰無仮説と対立仮説

1.  「母集団の平均は同じだ」という「帰無仮説」を立てる

    -   母語によって反応時間(あるいは正答率)は変わらない
    -   教育法によって成績は変わらない
    -   作家の年代や属性によってある構文の出現率は変わらない

2.  帰無仮説を棄却する水準$\alpha$を決める（分野で決まっていて、大抵は0.05）

3.  対立仮説(グループの違いが差を生んだ)の採用/棄却を決める

    -   「母集団の平均は同じ→グループ間の差が小さいデータが得られる」

    -   「グループ間の差」を反映する$t$値を計算

        -   $t$値はグループ間の差をデータのばらつきで割ったもの
        -   → グループ間の差が小さかったり、ばらつきが大きいと0に近づく

    -   $t$値は下の確率分布($t$分布)に従うので「グループ間の差がない」確率を求められる

    -   「グループ間の差がない」確率が$\alpha$未満なら、以下のステップを踏む

        1.  「グループ間の差が小さいデータが得られなかった」(有意な差があった)
        2.  「母集団の平均は同じではない」
        3.  帰無仮説を棄却、対立仮説を採用

```{r}
# 自由度8のt分布の見た目
t <- seq(-3, 3, 0.1)
plot(t, dt(t, df = 8))
```

別のケース

-   これはノートパソコンである(仮説)→キーボードがある(データ)

    -   キーボードがない→「これはノートパソコンではない」(仮説の棄却)
    -   ただし、**「キーボードがある→これはノートパソコンだ」とはいえない。**
        (例: デスクトップPC)
        -「母集団の平均は同じ(帰無仮説)」→「グループ間の差が小さいデータが得られる」
    -   「グループ間の差が小さいデータが得られない」→「同じではない」
    -   ただし、**「グループ間の差が小さいデータが得られる→同じ」**とはいえない。
        （例:
        適当な被験者がランダムに押しても、帰無仮説を支持するデータは得られる）

帰無仮説が真（本当は効果ない）なのに帰無仮説を棄却して対立仮説を採用する
のが致命的にまずい(これをType1-Errorと呼ぶ)。
$\alpha$が小さくなればなるほど、帰無仮説の棄却は難しくなるので、
Type1-Error はおきづらくなる(5章参照)。

## t検定ハンズオン

手順の復習

1.  帰無仮説を用意する

-   母語によって反応時間(あるいは正答率)は変わらない
-   教育法によって成績は変わらない
-   作家の年代や属性によってある構文の出現率は変わらない

2.  $\alpha$を0.05に決める
3.  帰無仮説通りグループ間の差がない確率を求め、
    0.05以下なら帰無仮説を棄却して対立仮説を採用する

実際にデータ(a)と(b)試してみましょう。

```{r}
head(data_a)
t.test(data_a$m, data_a$f, var = T)
```

data_aでは差が偶然である確率が0.3345なので、
手順3で帰無仮説を棄却できない(有意差なし)。
ここでいうtの値はp.51の式(5.1)にあるように以下となる。
(1をm、2をfとしている)
帰無仮説は「母平均に差がない」なので、$\mu_m-\mu_f$は0になる。
そして手元のデータの差が小さければ$t$は0に近づく(分子)。
また、データのばらつきが大きければ$t$はさらに0に近づく(分母)。

$$
t=\frac{(\bar{X_m}-\bar{X_f})-(\mu_m-\mu_f)}{s_{\bar{X_m}-\bar{X_f}}}
$$

よりばらつきの小さかった（分母が小さく、つまり0から離れる）
`data_b`も見てみると、たしかにtは大きくなっている。
同時に、p値は小さくなっている。

```{r}
t.test(data_b$m, data_b$f, var = T)
```

$p$が$\alpha$より小さいので、データ(b)からは帰無仮説を棄却できる。
したがって、対立仮説の「グループ間で母平均に差はある」を採用する。
df(自由度)はt値を求める際の分母(ばらつき)を求めるときにが必要 95 percent
confidence interval(CI)は対立仮説の0を含まないので、
棄却される(求め方はp.42の式4.3→4.4を5.1に適用)。

なお、差が+、あるいは-になると理論的にわかっている場合は
「片側検定」が使える。その際は$t$値が少し0に近づく(p.57)。

先程のデータは異なる個体の差を見たが、
同じ個体の変化を見る場合は「対応有りの$t$検定」が使える(p.61の5.6)。

また、$t$検定で仮定している正規性を確かめる方法はp.63、
グループ間の分散が異なる場合の対処はp.65以降にのっている。

## 全体のアウトライン

Day1

-   t検定
-   **補足: t検定と線形モデル**
-   ANOVA

Day2

-   LME
-   ランダム構造
-   モデル選択

## 線形モデルとの関連 (補足)

Day2でt検定やANOVAを拡張した線形モデルを扱うので、
t検定も線形モデルの枠組みで考えられることを補足

まず、身長をy、性別をxとしたとき、 y = ax + b
のような式で関連づけられます。
説明のため、データの形式を以下のように変更します。

```{r}
data_c <- data.frame(
  sex = c(rep(1, 15), rep(0, 15)),
  height = c(data_b$m, data_b$f)
)
data_c

# 図示
ggplot(data_c, aes(x = as.factor(sex), y = height)) +
  geom_boxplot()
```

上の図を見ると、x軸のfactorが0→1になると、
平均値の分だけマイナスになることがわかります。
そうなると、もともとの式は y = -1.51\*性別 + 146.1 のように表せます。
これを線形モデルでは「フォーミュラ」を使って表現します。
従属変数`~`独立変数のように表現します。

```{r}
# モデルはsummaryでp値なども確認できる。
summary(lm(height ~ sex, data = data_c))
# s_delta <- 0.5998
# summary(lm(height / s_delta ~ sex, data_c))
```

そうすると、Estimateが-1.51, sdが0.59,
tが-2.52(と、それに伴うp値)が一致しました。
ここでの$t$はもちろん、Estimate(傾きであり差でもある)/sd(ばらつき)です。

```{r}
# 結果は線形モデルと一致する
t.test(data_b$m, data_b$f, var = T)
```

t検定にはいくつも制限があります。
上の線形モデルの枠組みを広げていくと、以下の制限もなくなります。

-   独立変数はカテゴリカル(K=2)
-   従属変数は連続値(正規分布)
-   構造的なノイズを扱いづらい

## 全体のアウトライン

Day1

-   t検定
-   補足: t検定と線形モデル
-   **ANOVA**

Day2

-   LME
-   ランダム構造
-   モデル選択

## ANOVA

-   ANOVAの概要
-   1要因3水準
-   2要因2水準
-   補足

## ANOVAの概要

t検定の制限

-   **独立変数はカテゴリカル(K=2)**
-   従属変数は連続値(正規分布)
-   構造的なノイズを扱いづらい

ありうる分析したいケース(Kが3以上ある)

1.  一要因で水準が3以上あるケース(多重比較はｘ)
2.  要因が2つあって水準が2あるケース(交互作用の話)

## 1要因3水準(概要)

-   2つのグループの差ではなく、3つのグループ間で差があるかを見たい
-   注意: t検定を繰り返すのはType1-Errorが起きやすくなる
    (3回t検定を繰り返すと、その分だけ帰無仮説を棄却できるチャンスが増える)
-   → 一元配置の分散分析(6章)

t検定では同じ$\mu$であることを帰無仮説としたが、
ANOVAでもグループ間の$\mu$が等しいことが帰無仮説になる。

t検定ではt値とt分布を定義したが（グループ間の差/ばらつき）、
ANOVAではF値とF分布を利用する。

F値は(グループ間のばらつき/グループ内のばらつき)と定義でき、
これはグループ間でのばらつきが小さいほど0、
グループ内でのばらつきが大きいほど0に近づく。

下図は教科書p.72に近い図をランダムで作成する。
もしグループ間で差がなかったら
グループ間でのばらつき(色で示す)は小さくなるなる。
比較して、グループ内でのばらつきが大きくなる。
`SS_between_group`(グループ間のばらつき) と
`SS_within_group`(グループ内のばらつき) を動かしてみましょう。

```{r}
SS_between_group <- 2 # グループ間のばらつき
SS_within_group <- 1 # グループ内のばらつき
base <- 15
df_p72 <- data.frame(
  idx = 1:18,
  grp = c(rep(1, 6), rep(2, 6), rep(3, 6)),
  y = c(
    rnorm(6, base - SS_between_group, SS_within_group),
    rnorm(6, base, SS_within_group),
    rnorm(6, base + SS_between_group, SS_within_group)
  )
)
# df_p72 をプロット
ggplot(df_p72, aes(x = idx, y = y, color = as.factor(grp))) +
  geom_point()
```

F値は(グループ間のばらつき/グループ内のばらつき)と定義でき、
グループ間でのばらつきが小さいほど0、
グループ内でのばらつきが大きいほど0に近づきます。
上のデータで両方計算でき、そのデータが0から遠いほど
F分布の右裾に近づき、「グループ間で差がないデータ」である確率が下がります。
事前に決めた$\alpha$未満の時、t検定と同じく帰無仮説を棄却します。

F分布は2つの自由度によって定義できる。

-   グループの自由度(グループまとめての平均の自由度はグループ数-1)
-   サンプルの自由度(グループ内のサンプル数-1 \* グループ数)

```{r}
f_values <- seq(0, 5, 0.1)
p <- df(f_values, 3, 44)
plot(f_values, p, type = "l")
```

グループ間でのばらつきが小さいほど0、
グループ内でのばらつきが大きいほど0に近づく。
t値とは違い、大きいほど確率が下がる。

## 1要因3水準(ハンズオン)

教科書(p.77以降の6.3)を例に、実際に手を動かしてみる。
教科書ではデフォルトの`read.csv`を使う方法が紹介されていが、 ここでは
`tidyverse` が含む `readr` パッケージの `read_csv` を使う。
読み込んだデータは「湖によってストロンチウムの量は異なるか」というものになる。

```{r}
# Windowsで作ったデータだと読み込めないことがあるので注意
d2 <- readr::read_csv("../data/table6-3.csv")
d2
```

線形モデルと同様、従属変数`~`応答変数（要因）の形式を取る。
t検定のときと同様、summaryを使うとF値などを確認できる。

```{r}
summary(aov(stron ~ as.factor(lake), data = d2))
(2193.4 / 4) / (244.1 / 25)
```

ここで、2193.4 はグループ間平方和(SS.b)、 244.1
はグループ内平方和(SS.w)になる。
それぞれを自由で割るとグループ間分散、グループ内分散になる。
グループ間分散/グループ内分散がF値になる。
これが「グループ間でのばらつきが小さいほど0、
グループ内でのばらつきが大きいほど0に近づく」
F値は(グループ間のばらつき/グループ内のばらつき)になる。

F値はF分布に基づいて確率が求められ、t検定と同じ手順で帰無仮説を棄却できる。
(t検定の説明のtをFに変えただけ)

-   「母集団の平均は同じ→グループ間の差が小さいデータが得られる」

-   「グループ間の差」を反映する$F$値を計算

    -   $F$値はグループ間の差をデータのばらつきで割ったもの
    -   → グループ間の差が小さかったり、ばらつきが大きいと0に近づく

-   $F$値は下の確率分布($F$分布)に従うので「グループ間の差がない」確率を求められる

-   「グループ間の差がない」確率が$\alpha$未満なら、以下のステップを踏む

    1.  「グループ間の差が小さいデータが得られなかった」(有意な差があった)
    2.  「母集団の平均は同じではない」
    3.  帰無仮説を棄却、対立仮説を採用

## 1要因3水準(多重比較の話と対処)

「母集団の平均は同じ」という帰無仮説を棄却したとして、
結局どこに有意な差があったかに興味があるケースを考える。
ANOVAのモチベーションと同様、t検定を繰り返して見つけるのは
Type1-Errorを引き起こすのでよくない。
教科書ではp.85から説明が始まるが、結局
「ボンフェローニの方法がいいよね」となっている。

一般的なボンフェローニは厳しすぎるので、
所定の手順で緩めた「ホルムの方法」を使うと
「適切に帰無仮説を棄却できる」。
結果は下のように三角になり、どことどこの間に有意差があるかがわかる。

```{r}
pairwise.t.test(d2$stron, d2$lake, p.adj = "holm")
# ?pairwise.t.test
```

## 2要因2水準(概要)

-   交互作用を扱える
-   AとBの要因の組み合わせが効果あるんだ、と狙いに行くタイプ
-   Aに興味があるんだけど、Bも変わってしまうから防ぎに行くタイプ

実際にデータを見てみる。教科書p.101にある 「植物の育ち具合に対する 1.
土壌の質 2. 肥料の有無 3. その両方 の効果」 を検証するデータ

```{r}
d_soil <- readr::read_csv("../data/table7-2.csv")
# mutate を使って数値→要因に変換してあげると良い。
d_soil <- mutate(d_soil, soil = as.factor(soil), ft = as.factor(ft))
d_soil
```

```{r}
# p.103通りではないが、ばらつきも含めて図示できる
ggplot(d_soil, aes(x = soil, y = plant, color = ft, shape = ft)) +
  geom_boxplot()
```

まず、ft(肥料)が2（あり）だとプラス、人工土(2)だとマイナスの影響がありそう。
さらに、肥料と土壌の質の組み合わせでも効果がありそう。

## 2要因2水準(ハンズオン)

```{r}
summary(aov(plant ~ soil + ft + soil:ft, data = d_soil))
# summary(aov(plant~soil*ft, data=d_soil))  # とも書ける
(71.3 / 1) / (399.4 / 36)
```

今回のFはそれぞれの効果ごとに求めている。
つまり、土壌のFは（土壌間のばらつき/グループ内のばらつき）となる。
復習すると、Fは「効果がないときに0に近づき、効果があるときに0から外れる値」になる。
土壌の効果があるとき、土壌間のばらつきは大きくなり（上の図の左右で、中心が遠くなる）、
グループ内のばらつきは小さくなる（上の図の左なら左で、まとまる）。
結果の見方として、主効果、交互作用共に効果は有意だった。

## 補足: 実験デザイン

こうしたケースの他に、交互作用が気になるケースとして他の例もある。

-   日本語母語話者は ebzo の bz間に母音を知覚する

    -   ebuzoの/u/を徐々に減らしていっても/u/を知覚するはず
    -   → /u/の持続時間(あるいは有無)が要因になる。
    -   → ただ、音響的に短いので/u/を知覚するチャンスは小さくなる。
    -   → ベースラインとしてフランス語母語話者を考える
    -   → 言語+持続時間+言語:持続時間 の3つの効果をみて解決

```{r}
d_dupoux <- data.frame(
  Language = c(rep("Japanese", 2), rep("French", 2)),
  Duration = c("Full", "0 ms.", "Full", "0 ms."),
  Percent = c(95, 70, 96, 10)
)
ggplot(d_dupoux, aes(x = Duration, y = Percent, color = Language)) +
  geom_boxplot()
```

実験デザインの段階から考えないと、他の解釈が出てきてつらいので注意しましょう。
演習7.1に2要因2水準の結果が複数パターン描かれています。
他にも種類はいくつかあるので、事前に予想すると良いと思います。

## まとめ

-   要因が一つで水準（グループ）が2つのとき→t検定
-   要因が一つで水準（グループ）が3つ以上のとき→ANOVA
-   2要因2水準で交互作用を見たい時 →ANOVA

残りの問題

-   連続値の独立変数
-   ランダム構造(被験者の効果やアイテムの効果)

## 全体のアウトライン

Day1

-   t検定
-   補足: t検定と線形モデル
-   ANOVA

**Day2**

-   LME
-   ランダム構造
-   モデル選択
