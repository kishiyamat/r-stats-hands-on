---
title: "Day1"
output: ioslides_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 『Rで学ぶ統計学入門』勉強会

## 概要

* 『Rで学ぶ統計学入門』を教科書として統計学の基本（4章まで）と初歩的な応用（8章まで）をそれぞれ90分ずつ読み進める。
* 初学者にとって理解が困難な点や、事前に頂いた質問などから、補足する部分や飛ばす部分を決めて進行します。
* 躓くことの多い環境構築の部分や、打ち込むのが面倒なデータの部分はこちらが提供します。  
* 対象者は初学者とそうでない人半々. 質問は随時受け付け

ゼミの方向け(7/15,22): 難しい箇所、むしろ飛ばしても構わない箇所など
あれば随時Google Formからコメントもらえると助かります。
(コピペしながらがよいのか、ワークシートを用意したほうがよいのか。)

<!-- TODO: お絵かきポイントも整理する -->

# Ch.1 統計学を学ぶ大切さ

## Ch.1 の目標

- データの解釈を批判的に見てみる
- データの比較に使う記述統計量を思い出す
- R言語を扱う動機を共有し、セットアップをする

## 1.1 TV番組で流れる "実験" の怪しさ

データの解釈を批判的に見てみる練習をしましょう

1. 個人で(1)の第一パラグラフを読み、以下を行ってください。
   * **仮説**と**実験**、**結果**と**解釈**に整理してください。
   * 解釈が妥当か妥当でないか、根拠を考えて整理してください。

## 1.1 TV番組で流れる "実験" の怪しさ

想定解答

1. 妥当 (上がったのは事実なので仮説は支持できる)
1. 妥当でない (時間の効果かもしれないので、なにもしない比較対象のグループが必要)
1. 妥当でない (一人のデータからそんなに強く主張できない)

<!-- 議論で、何かが上がった下がったという主張のサポートは -->
<!-- 偶然じゃないのかとか、個人差じゃないのかとか、 -->
<!-- 色々な疑問が出てきて、安易には判断できないことがわかるのではないでしょうか。 -->

-> データを比較するときに大切な考え方を次に見ます。

<!-- 教科書の(2)は(1)とタスクは似ているのでスキップします(時間に余裕があれば着手)。 -->

## 1.2 平均とばらつきの療法が重要: 記述統計量

* 差があるときのパターン
  * 本当は同じ平均を持つ(4年生データ)
  * 本当は異なる平均を持つ(6年生データ)
* データの選択（サンプリング）で「本当の値(平均)」からはズレる。
* 手元のデータのばらつきから、本当の平均の範囲を推定できれば議論できそう

例えば...

* 6年生女子の平均は 145--148 の間に95%の確率で入る
* 6年生男子の平均は 144だった
* → 同じグループであるという主張(仮説)を棄却する

## 1.3 統計を学ぶ大切さ: 推定・検定・予測

用語の説明と章との関連を示します。

1. 推定: 2, 3, 4章
1. 検定: 5, 6 章
1. 予測: 8, 9, 10 章

## Rの説明 (pp.1--2)

* オープンソース
* 統計に強い
* 可視化も楽

## Rのセットアップ

1. https://binder.cs.rcos.nii.ac.jp/v2/gh/kishiyamat/r-stats-hands-on/main にアクセス
1. NIIのウェブページで所属機関を[選択]し、ご自身の所属機関で認証(自分用の分析環境が新たに作られます)
1. Files の右側にある New → RStudio をクリック(RStudio が新しいタブで開きます)

## Ch01.md の目標ふりかえり

- データの解釈を批判的に見てみる -> 統計的に主張したい
- データの比較に使う記述統計量を思い出す -> ばらつきから本当の値の範囲をしりたい
- R言語を扱う動機を共有し、セットアップをする -> 完了？

# Ch.2 母集団と標本

## Ch.2 の目標

- 用語を整理する(母集団と標本, 無作為抽出, 母平均$\mu$と母分散$\sigma^2$)
  - 母集団から標本を無作為抽出 -> (母分散を推定) -> 母平均の幅を推定
  - 「t分布」の説明にも必要
- Rを使って計算してみる

## 2.1 母集団と標本の関係

順当に読み進め太字、記号の意味を押さえていく

- 統計の目的: **母集団**の性質（**母平均**、**母分散**）を**標本**から**推定**
- 記号の意味の説明 (わからない値はギリシャ文字に置かれがち)
  - 母平均を$\mu$、母分散を $\sigma^2$
  - 標本平均を $\bar{X}$、標本分散を $s^2$
- 無作為抽出: 標本を母集団からランダムに抽出(p.12)

## 2.2 標本の性質

p.13以降は徐々に数式が増えていくのでRのコードで補足.

```{r}
# p.13 のデータ
# <- で変数に10の数値を代入、cはconcatenateのc
A <- c(3, 4, 4, 5, 5, 5, 5, 6, 6, 7)
B <- c(1, 2, 4, 4, 5, 5, 5, 6, 8, 10)
# repはrepeat 例. rep("SampleA", 10)
# データフレーム: エクセルのようなもの. 列に要因、行に観測を持つ
df1 <- data.frame(
  values = c(A, B),
  labels = c(rep("SampleA", 10), rep("SampleB", 10))
)
```

※作成した環境にコピペして動かしてみましょう。
(Zoom画面、スライド、RStudio動かすの流石に面倒ですかね？)

## 2.2 標本の性質

最初の行を見る関数(機能)

```{r}
# 最初の6行を見せて、という意味
head(df1, 6)
```

## 2.2 標本の性質

```{r, fig.height=3, message=FALSE}
library(ggplot2)  # 可視化
# SampleAもSampleBも5あたりに中心があるけれど、
# ばらつきはSampleBの方が大きいですね。
ggplot(df1) +
  facet_wrap(. ~ labels) +
  geom_histogram(aes(x = values))
```

## 2.2 標本の性質

p.14以降の準備

```{r}
# https://whatalnk.github.io/stat-intro-by-r-tkd/Chap02.html
A <- c(
  43.3, 43.1, 42.6, 42.4, 42.2, 41.8, 41.7, 41.6, 41.5, 41.4,
  40.8, 40.6, 40.5, 40.4, 40.4, 40.3, 40.2, 39.9, 39.9, 39.8,
  39.7, 39.6, 39.6, 39.5, 39.4, 39.3, 38.9, 38.9, 38.8, 38.8,
  38.7, 38.7, 38.6, 38.6, 38.5, 38.4, 38.3, 38.2, 38.1, 38.1,
  37.6, 37.4, 37.1, 37.8, 37.6, 37.5, 37.4, 37.3, 37.2, 37.1,
  37.1, 36.6, 36.5, 36.5, 36.4, 36.3, 36.2, 36.1, 35.4, 35.3,
  35.2, 35.1, 35.1, 34.7, 34.3, 34.2, 33.2, 33.1, 32.7, 31.5
)
```

## 2.2 標本の性質

p.14以降の準備

```{r}
# https://whatalnk.github.io/stat-intro-by-r-tkd/Chap02.html
B <- c(
  47.3, 46.1, 45.6, 45.1, 44.5, 44.4, 43.7, 42.6, 42.5, 42.5,
  41.4, 41.8, 41.6, 41.5, 40.7, 40.5, 40.4, 40.3, 40.1, 40.1,
  39.9, 39.8, 39.7, 39.6, 39.6, 39.5, 39.4, 38.9, 38.8, 38.8,
  38.7, 38.7, 38.6, 38.4, 38.2, 38.1, 38.1, 37.8, 37.7, 37.5,
  37.5, 37.4, 37.3, 37.3, 37.1, 36.8, 36.8, 36.7, 36.6, 36.4,
  36.2, 35.4, 35.4, 35.4, 35.3, 35.2, 34.9, 34.8, 34.7, 34.7,
  33.9, 33.8, 33.7, 33.3, 33.1, 32.8, 32.5, 32.1, 31.7, 29.5
)
```

## 2.2 標本の性質

```{r echo=TRUE, message=FALSE, warning=FALSE, fig.height=3}
# データフレーム(p.14)
df2 <- data.frame(
  values = c(A, B),
  labels = c(rep("SchoolA", length(A)), rep("SchoolB", length(B)))
)
ggplot(df2) +
  facet_wrap(. ~ labels) +
  geom_histogram(aes(x = values))
```

## 2.2.1 中心や位置を表す指標 (p.15~)

平均値を $\bar{X}=1/n\Sigma_{i=1}^{n}X_i$ としています。
人によっては下のRコードで見たほうが理解しやすいかもしれません。
具体的に、`X_A_bar`(つまり$\bar{X}_\rm{A}$) は以下のように求められます。

```{r}
X_A_bar = sum(A)/length(A)
X_A_bar
# 課題: `X_B_bar` を求めてみてください。
```

中央値や最頻値は飛ばします。なお、繰り返しになりますが
母平均は$\mu$、標本平均は$\bar{X}$としています。

## 2.2.2 ばらつきを表す指標(a. 平方和)

```{r, fig.height=2.5}
X_A = df2[df2$labels=="SchoolA", "values"]  # 実データ
dev = X_A - mean(X_A)  # 偏差
S = (X_A - mean(X_A))^2  # squared
SS = sum(S)  # 平方和(2.2)
par(mfrow=c(1,3)) 
plot(X_A)  # 実データ
plot(dev)  # 偏差: 和は打ち消し合って0 -> all.equal(sum(dev), 0) 
plot(S)  # 平均で0、外れるほど+
```

## 2.2.2 ばらつきを表す指標(b.c)

<!-- 2012 年度の高 1 生より，データの分析(統計学) が必修単位として導入された -->
<!-- 高校はクラス間の比較などの全数調査になっている。不偏分散が新しい -->

- b. 標本分散SVは標本数で増えるのでnや(n-1)で割る
- c. 標準偏差$\sqrt{s^2}$ ($\sigma$ではない)
- 不偏分散$s^2$ は(n-1)で割る
コラム2.3を参照

```{r}
SS = sum(S)  # 平方和(2.2)
n = length(X_A)
SV = SS/(n-1)  # 標本分散
sqrt(SV)  # 標準偏差
sd(X_A) == sqrt(sum((X_A - mean(X_A))^2)/(n-1))  # Rのsdはn-1バージョン
```

<!-- このsdの値は色々なところに使える。値が正規分布に従うとき、 -->
<!-- +-2sdは95%になる。 -->
<!-- ちゃんともとのグラフのばらつき具合を反映できていることを確認する -->

## 2.3 Rを使って計算してみよう

RStudioのコンソールに打ち込んで練習しましょう。

```{r}
d = c(1,2,3,4,5,6,7,8,9,10)
mean(d)
var(d)  # 不偏分散
sd(d)  # 標準偏差
```

## 演習問題

答えは次ページ

```{r}
data = c(5.1, 7.4, 10.3, 9.2, 6.5, 6.1, 7.9, 8.4, 8.1, 9.4)
# 2.1
# 2.2
```

## 演習問題(2.1)

```{r}
data = c(5.1, 7.4, 10.3, 9.2, 6.5, 6.1, 7.9, 8.4, 8.1, 9.4)
# 2.1
mean(data)  # 平均値: [1] 7.84
var(data)  # 不偏分散: [1] 2.582667
sqrt(var(data))  # 標準偏差: [1] 1.607068
```

## 演習問題(2.2)

```{r}
data = c(5.1, 7.4, 10.3, 9.2, 6.5, 6.1, 7.9, 8.4, 8.1, 9.4)
# 2.2
n = length(data)
d.mean = sum(data)/n  # 平均値: [1] 7.84
d.var = sum((data - d.mean)^2)/(n-1)  # 不偏分散: [1] 2.582667
d.sd = sqrt(d.var)  # 標準偏差: [1] 1.607068
print(c(d.mean, d.var, d.sd))
```

一旦質問の時間

## Ch.2 の目標

- 用語を整理する(母集団と標本, 無作為抽出, 母平均$\mu$と母分散$\sigma^2$)
  - 母集団から標本を無作為抽出 -> (母分散を推定) -> 母平均の幅を推定
  - 「t分布」の説明にも必要
- Rを使って計算してみる

# Ch.3 大数の法則、正規分布、中心極限定理

## Ch.3 の目標

- 大数の法則: 標本サイズが大きくなると平均は母集団平均に近づく(p.28まで)
- 正規分布の定義はさておき、正規分布の性質には慣れる
- 中心極限定理で「平均が集まって作られる分布」という概念に慣れる
- Rで分布

## 3.1 大数の法則

p.28まで

大数の法則: 標本サイズが大きくなると平均は母集団平均に近づく

* 以下の2つを比べたとき、大抵の場合は後者のほうが0.5(母集団平均)に近い
  * 10回のコイントスで平均を求める
  * 10000回のコイントスで平均を求める
* 回数を大きくすると、0.5(母集団平均)に近づくというシミュレーションをしている。

## 3.2 正規分布

定義自体は(3.6)だが以下の性質が大事

* 図3.4が示す通り、平均と標準偏差によって形が変わる
* 先の下側の面積は1になる
* 平均+-2x標準偏差の範囲が約0.95
* 製造した缶の重さなどなど、多くのデータが従う

```{r}
mean = 10
sd = 2
# 平均から2sdに収まる確率は、mean+2*sd から mean-2*sd を引けば良い
# pnormで与えたmeanとsdの分布におけるxまでの面積を求めくれる
# pnorm(-Inf, mean=mean, sd=sd)  # ->0
# pnorm(Inf, mean=mean, sd=sd)  # ->1
pnorm(mean+2*sd, mean=mean, sd=sd)-pnorm(mean-2*sd, mean=mean, sd=sd)
```

## 3.3 中心極限定理

1. とある特性(平均$\mu$としましょう)を持った母集団を用意します。
1. 母集団から(例えば)10のデータを取り平均$X_\rm{A}$を求め、これを一試行とします。
1. 上の試行をたくさん(教科書でいうところの$M$回)して$X_\rm{A, B, ...}$すると、
   * $X_\rm{m}$は$\mu$を平均とする正規分布に従います。
   * 一試行のサンプル数(上だと10)が小さいと収束が悪くなります。

-> これが「平均が集まって作られる分布」という概念です。
データが正規分布に従っているかは
qqnormを使って見る方法や、
統計的に検証する方法があります(後述)。

## 演習問題

```{r}
# 3.1 (1)
# 3.1 (2)
# 3.2は飛ばした二項分布なのでパス(dbinomを使う)
```

## 演習問題

```{r}
# 3.1(1)
mean = 145.8
sd = 4
1000*(pnorm(156, mean=mean, sd=sd)  - pnorm(153, mean=mean, sd=sd))
# 3.2は飛ばした二項分布なのでパス(dbinomを使う)
```



# Ch.4 推定と誤差


## 演習問題

R初出