---
title: "Day2"
output: ioslides_presentation
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(readr)
library(dplyr)
library(lme4)
library(lmerTest)
```

# 『Rで学ぶ統計学入門』勉強会

## 全体のアウトライン

Day1

-   t検定
-   補足: t検定と線形モデル
-   ANOVA

**Day2**

-   LMEとランダム構造
-   複数のランダム効果と実例
-   モデル選択
-   (LMEの拡張)

## 前回の復習

-   t検定
    -   帰無仮説を立てた検定
    -   概要: 差がないときに0となる値tを計算、仮説の棄却・採用
-   補足: t検定と線形モデル
    -   データフレーム
    -   フォーミュラ
    -   モデル
-   ANOVA
    -   多重比較
    -   交互作用

## t検定の復習

-   帰無仮説を立てた検定
-   概要: 差がないときに0となる値tを計算、仮説の棄却・採用

```{r}
data_b <- data.frame(
  m = c(142.3, 142.5, 145.7, 143.5, 144.2, 145.1, 145.9, 145.2, 146.8, 145.7, 145.4, 144.6, 144.2, 145.9, 142.1),
  f = c(143.5, 144.6, 143.4, 146.6, 145.3, 147.7, 147.2, 147.8, 145.3, 145.7, 147.5, 147.2, 148.8, 147.9, 143.3)
)
t.test(data_b$m, data_b$f, var = T)
```

このtは独立変数(要因)の変化に伴う従属変数の変化を、
ばらつきで割ったものでした。
本当の平均値$\mu$が同じであると仮定した場合、
手元のデータの平均も同じなら0になるような値です。
もし同じでないなら、0からはずれていきます。
そして事前に決めた$\alpha$に従って帰無仮説（元の仮定）を棄却します。

$$
t=\frac{(\bar{X_m}-\bar{X_f})-(\mu_m-\mu_f)}{s_{\bar{X_m}-\bar{X_f}}}
$$

このt検定は「線形モデル」という見方もできました。

## 補足: t検定と線形モデル

-   データフレーム: `data_c`
-   フォーミュラ: `height ~ sex`
-   モデル: `lm`

```{r}
# データフレーム
data_c <- data.frame(
  sex = c(rep(1, 15), rep(0, 15)),
  height = c(data_b$m, data_b$f)
)
# 図示
ggplot(data_c, aes(x = as.factor(sex), y = height)) +
  geom_boxplot()
```

上の図を見ると、x軸のfactorが0→1になると、
平均値の分だけマイナスになることがわかります。
そうなると、もともとの式は y = -1.51\*性別 + 146.1 のように表せます。
これを線形モデルでは「フォーミュラ」を使って表現します。
従属変数`~`独立変数のように表現します。

```{r}
# モデルはsummaryでp値なども確認できる。
summary(lm(height ~ sex, data = data_c))
# 傾き(効果、差)とばらつきとtの関係は今後も出てきます。
```

この「線形モデル」の枠組みを広げて、ランダム構造を考えていきます。

-   ランダム構造(被験者の効果やアイテムの効果)
-   連続値の独立変数など

## LMEとランダム構造

ランダム構造を考えるにあたって、 まずはサンプルデータを見てみましょう。
夜ふかし何日目かがx、反応時間がyに入っているデータです。
先程は右肩下がりでしたが、今回は右肩あがりなデータになっています。

```{r}
ggplot(sleepstudy, aes(x=as.factor(Days), y=Reaction))+
  geom_boxplot()
```

今回のデータも傾き(効果、差)とばらつき、tの関係がなりたちます。
傾きとして、Xが5増えるとYは50増えているので、傾きは10くらいになりそうです。
Xが0の時のYが切片になるので、切片は250くらいです。 そうすると、 y =
10\*x + 250 という式が作れそうです。

Rの `f = Reaction ~ Days` という式は  `f = Reaction ~ Days + 1` 
の略です。これを `lm`に与えると、Daysと1にかけてReactionとなるような値を
推定してくれます。

```{r}
f = Reaction ~ Days
m = lm(f, sleepstudy)
summary(m)
```

ですので、厳密には $y = 10.467*x + 251.405$ という式が作れそうです。
ただ実はこのデータ、複数の被験者がいます。
人により、寝不足の影響がない人(335)や、
順当に反応時間が遅くなる人(308)もいそうです。傾きが違えば、線を引いた時の切片も違いそうです。

```{r}
ggplot(sleepstudy, aes(x=as.factor(Days), y=Reaction))+
  facet_wrap(.~Subject) +
  geom_boxplot()
```

こうした個人差を考えないで直線を引くだけでは、
過剰に反応する被験者がいた時や全く逆の反応をする被験者に
引っ張られてしまいます。
ですので、こうした「ランダムな傾き・切片」と興味のある「固定効果」を
混ぜて線形モデルを作ってあげます。
この混ぜたモデルのことを「線形混合モデル」と呼びます。

具体的な式を見てみると、もともとは $y = 10.467*x + 251.405*1$ でしたが、
ここに「ランダムな傾き・切片」を混ぜてみます。そうすると、

$$
y = (10.467+被験者308のランダム効果)*\rm{Days} + (251.405+被験者308のランダム切片)*1
$$
となります。さきほど、以下のような話をしました。

> Rの `f = Reaction ~ Days` という式は  `f = Reaction ~ Days + 1` 
> の略です。これを `lm`に与えると、Daysと1にかけてReactionとなるような値を
> 推定してくれます。

つまり、`Reaction ~ Days` を与えると全体の傾きと切片をもとめてくれます。

ここで次に `Reaction ~ Days+1 + (Days+1|Subject)` という式を考えてみます。
これを `lmer` に与えると、
被験者ごとの傾きと切片`(Days+1|Subject)`を考慮して
全体の傾きと切片を求めてくれます。
全体の傾きと切片は `summary` で確認できます。

```{r}
f_lmer = Reaction ~ Days+1 + (Days+1|Subject)
m = lmer(f_lmer, sleepstudy)
summary(m)
```

被験者ごとのランダム効果（傾き、切片）は`ranef`で確認できます。
さきほど、

> 人により、寝不足の影響がない人(335)や、
> 順当に反応時間が遅くなる人(308)もいそうです。傾きが違えば、線を引いた時の切片も違いそうです。

といいましたが308は+になっているので、うまく反映されていそうです。

```{r}
ranef(m)$Subject
```

被験者番号308の方を見ると、以下のように効果が求まったと解釈できます。

$$
\rm{Reaction} = 10.467*\rm{Days} + 251.405*1 + (9.1989758*\rm{Days} + 2.2585509	*1)
$$

さらに式を変えると以下のように書き換えられます。

$$
\rm{Reaction}= (10.467+9.1989758)*\rm{Days} + (251.405 + 2.2585509)*1
$$

このカッコには固定効果とランダム効果が混在しています。
これが線形混合モデルの混合の意味になります。
これでランダム効果を考慮しつつ、傾き、ばらつき、t値、p値を求めてくれます。

```{r}
summary(m)
```

実際に実験をする際は複数のアイテム、複数の被験者に対して行う。

-   一つのアイデムでは「そのアイテムだったからでは？」と突っ込めてしまう
-   一つの被験者では「その被験者だったからでは？」と突っ込めてしまう

lmer を使うと、上記のようにランダム構造を仮定でき、
しかも同時に複数のランダム要因を考慮できます。
実際の実験を見ながら、被験者とアイテムのランダム要因のモデルを試してみましょう。

## 複数のランダム効果と実例

具体例とともに見ていきましょう。

```{r}
sleepstudy
```

## モデル選択

## 実験
